<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>음성 입력</title>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body>
<h2>음성 입력하기</h2>
<form id="speechForm"> <!-- 폼 추가 -->
    {% csrf_token %}
    <!-- 다른 폼 입력 요소들 -->
    <button type="button" id="startButton">음성 입력 시작</button> <!-- type="button" 추가 -->
</form>
<p id="transcription"></p>

<script>
    const startButton = document.getElementById('startButton');
    const transcription = document.getElementById('transcription');

    // CSRF 토큰을 가져오는 함수
    function getCsrfToken() {
        const csrfTokenElement = document.querySelector('input[name="csrfmiddlewaretoken"]');
        if (csrfTokenElement) {
            return csrfTokenElement.value;
        } else {
            console.error('CSRF 토큰을 찾을 수 없습니다.');
            return null;
        }
    }

    // 음성 합성 함수
    function speak(text) {
        const synth = window.speechSynthesis;
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = 'ko-KR';
        synth.speak(utterance);
    }

    // 음성 인식 시작 함수
    function startSpeechRecognition() {
        // 음성 인식 API를 지원하는지 확인
        if (!('webkitSpeechRecognition' in window)) {
            alert("음성 인식이 지원되지 않는 브라우저입니다.");
        } else {
            const recognition = new webkitSpeechRecognition(); // 음성 인식 객체 생성
            recognition.lang = 'ko-KR'; // 언어 설정 (한국어)

            recognition.start(); // 음성 인식 시작

            // 음성 인식 결과 이벤트 처리
            recognition.onresult = function (event) {
                const transcript = event.results[0][0].transcript;
                transcription.textContent = transcript;

                // CSRF 토큰 가져오기
                const csrfToken = getCsrfToken();

                // 서버로 음성 데이터 전송
                axios.post('{% url "orders:aibot" %}', {inputText: transcript}, {
                    headers: {
                        'X-CSRFToken': csrfToken // CSRF 토큰을 요청 헤더에 추가
                    }
                })
                    .then(function (response) {
                        const responseText = response.data.responseText;
                        console.log('서버 응답:', responseText);
                        // 서버 응답을 음성으로 출력
                        speak(responseText);
                    })
                    .catch(function (error) {
                        console.error('에러:', error);
                    });
            };

            // 음성 인식 종료 이벤트 처리
            recognition.onend = function () {
                startButton.textContent = '음성 입력 다시 시작';
            };
        }
    }

    // 버튼 클릭 시 음성 인식 시작
    startButton.addEventListener('click', startSpeechRecognition);

</script>

</body>
</html>
