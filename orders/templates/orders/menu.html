<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Silver Lining</title>
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* Í∏∞Ï°¥ Ïä§ÌÉÄÏùº */

        .menu-item,
        .selected-item {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 10px;
            margin: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            flex-direction: column;
            transition: transform 0.2s;
        }

        .menu-item img {
            width: 250px;
            height: 250px;
        }

        .menu-item:hover {
            transform: scale(1.05);
        }

        .selected-item span {
            margin: 0 5px;
        }

        .actions button {
            margin: 5px;
        }

        .card-body {
            text-align: center;
        }

        .fly-to-cart {
            position: absolute;
            z-index: 1000;
            transition: transform 1s ease-in-out;
        }

        #selectedItemsList {
            display: flex;
            flex-direction: column;
            gap: 10px;
            align-items: center;
        }

        .selected-item {
            display: flex;
            align-items: center;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            flex-direction: row;
            width: 600px;
            margin: 5px 0;
        }

        .selected-item img {
            width: 50px;
            height: 50px;
            margin-right: 10px;
        }
    </style>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body>
<div class="container mt-5">
    <h2 class="text-center mb-4">Silver Lining</h2>
    <form id="speechForm">
        {% csrf_token %}
    </form>
    <p id="transcription"></p>

    <div class="button d-flex flex-wrap justify-content-center" id="menuContainer">
    </div>

    <div class="selected-items mt-4">
        <h3 class="text-center">ÏÑ†ÌÉùÌïú ÏÉÅÌíà üõí</h3>
        <div id="selectedItemsList"></div>
    </div>
    <div class="total-price mt-3">
        <h3 class="text-center">Ï¥ù Í∏àÏï°: <span id="totalPrice">0Ïõê</span></h3>
    </div>
    <div class="actions text-center">
        <button class="btn btn-danger" onclick="clearItems()">Ï†ÑÏ≤¥ÏÇ≠Ï†ú</button>
        <button class="btn btn-success" id="submitOrderBtn">Í≤∞Ï†úÌïòÍ∏∞</button>
    </div>
</div>

<script>
    window.addEventListener('load', function () {
        const hashtags = "";
        updateMenus(hashtags)
        const welcomeMessage = "Î∞òÍ∞ëÏäµÎãàÎã§. ÏõêÌïòÏãúÎäî Î©îÎâ¥Î•º Ï∂îÏ≤úÌï¥ ÎìúÎ¶¨Í≤†ÏäµÎãàÎã§. ÌïÑÏöîÌïú Í≤ÉÏù¥ ÏûàÎã§Î©¥ ÎßêÏîÄÌï¥Ï£ºÏÑ∏Ïöî.";
        speak(welcomeMessage, startSpeechRecognition);
    });

    const startButton = document.getElementById('startButton');
    const transcription = document.getElementById('transcription');

    function getCsrfToken() {
        const csrfTokenElement = document.querySelector('input[name="csrfmiddlewaretoken"]');
        if (csrfTokenElement) {
            return csrfTokenElement.value;
        } else {
            console.error('CSRF ÌÜ†ÌÅ∞ÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.');
            return null;
        }
    }

    function speak(text, callback) {
        const synth = window.speechSynthesis;
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = 'ko-KR';
        utterance.onend = function () {
            console.log("ÏùåÏÑ± ÏïàÎÇ¥Í∞Ä ÎÅùÎÇ¨ÏäµÎãàÎã§.");
            if (callback) {
                callback();
            }
        };
        synth.speak(utterance);
    }

    function startSpeechRecognition() {
        if (!('webkitSpeechRecognition' in window)) {
            alert("ÏùåÏÑ± Ïù∏ÏãùÏù¥ ÏßÄÏõêÎêòÏßÄ ÏïäÎäî Î∏åÎùºÏö∞Ï†ÄÏûÖÎãàÎã§.");
        } else {
            const recognition = new webkitSpeechRecognition();
            recognition.lang = 'ko-KR';
            recognition.start();
            recognition.onresult = function (event) {
                const transcript = event.results[0][0].transcript;
                transcription.textContent = transcript;
                const csrfToken = getCsrfToken();
                axios.post('{% url "orders:aibot" %}', {inputText: transcript}, {
                    headers: {
                        'X-CSRFToken': csrfToken
                    }
                })
                    .then(function (response) {
                        const responseText = response.data.responseText;
                        const hashtags = response.data.hashtags;
                        console.log('ÏÑúÎ≤Ñ ÏùëÎãµ:', responseText);
                        updateMenus(hashtags); // Î©îÎâ¥ ÏóÖÎç∞Ïù¥Ìä∏ Î®ºÏ†Ä Ïã§Ìñâ
                        speak(responseText, startSpeechRecognition); // Í∑∏ Îã§ÏùåÏóê ÏùåÏÑ± ÏïàÎÇ¥ Ïã§Ìñâ
                    })
                    .catch(function (error) {
                        console.error('ÏóêÎü¨:', error);
                    });
            };
            recognition.onend = function () {
                startButton.textContent = 'ÏùåÏÑ± ÏûÖÎ†• Îã§Ïãú ÏãúÏûë';
            };
        }
    }

    function updateMenus(hashtags) {
        $.ajax({
            url: '/orders/get_menus/',
            data: {hashtags: hashtags},
            dataType: 'json',
            success: function (data) {
                const menus = data.menus;
                const menuContainer = $('#menuContainer');
                menuContainer.empty();
                menus.forEach(menu => {
                    const menuItem = `
                        <div class="menu-item card" onclick="addItem('${menu.food_name}', ${menu.price}, '${menu.img_url}', this)">
                            <img src="${menu.img_url}" alt="${menu.food_name}" class="card-img-top">
                            <div class="card-body text-center">
                                <h5 class="card-title text-primary">${menu.food_name}</h5>
                                <p class="card-text text-muted">${menu.price}Ïõê</p>
                            </div>
                        </div>
                    `;
                    menuContainer.append(menuItem);
                });
            },
            error: function (error) {
                console.error('Î©îÎâ¥ ÏóÖÎç∞Ïù¥Ìä∏ Ï§ë Ïò§Î•ò Î∞úÏÉù:', error);
            }
        });
    }

    const selectedItems = {};

    function addItem(name, price, imgUrl, element) {
        if (!selectedItems[name]) {
            selectedItems[name] = {price: price, count: 1, imgUrl: imgUrl};
        } else {
            selectedItems[name].count += 1;
        }
        updateSelectedItemsList();
        flyToCart(element, document.getElementById('selectedItemsList'));
    }

    function updateSelectedItemsList() {
        const selectedItemsList = document.getElementById('selectedItemsList');
        selectedItemsList.innerHTML = '';
        let totalPrice = 0;
        for (const [name, item] of Object.entries(selectedItems)) {
            const itemElement = document.createElement('div');
            itemElement.classList.add('selected-item');
            itemElement.innerHTML = `
                <img src="${item.imgUrl}" alt="${name}">
                <span>${name}</span>
                <span>${item.price}Ïõê</span>
                <span>${item.count}Í∞ú</span>
                <button class="btn btn-danger btn-sm" onclick="removeItem('${name}')">ÏÇ≠Ï†ú</button>
            `;
            selectedItemsList.appendChild(itemElement);
            totalPrice += item.price * item.count;
        }
        document.getElementById('totalPrice').textContent = `${totalPrice}Ïõê`;
    }

    function removeItem(name) {
        if (selectedItems[name]) {
            delete selectedItems[name];
            updateSelectedItemsList();
        }
    }

    function clearItems() {
        for (const key in selectedItems) {
            delete selectedItems[key];
        }
        updateSelectedItemsList();
    }

    function flyToCart(element, targetElement) {
    const imgToDrag = element.querySelector("img");
    if (imgToDrag) {
        const imgClone = imgToDrag.cloneNode(true);
        let rect = imgToDrag.getBoundingClientRect();
        imgClone.style.position = 'absolute';
        imgClone.style.top = rect.top + 'px';
        imgClone.style.left = rect.left + 'px';
        imgClone.style.width = '250px'; // Ï¥àÍ∏∞ Ïù¥ÎØ∏ÏßÄ ÌÅ¨Í∏∞
        imgClone.style.height = '250px'; // Ï¥àÍ∏∞ Ïù¥ÎØ∏ÏßÄ ÌÅ¨Í∏∞
        imgClone.classList.add('fly-to-cart');
        document.body.appendChild(imgClone);

        // üõí ÏïÑÏù¥ÏΩò ÏúÑÏπò ÏÑ§Ï†ï
        const cartIconRect = targetElement.getBoundingClientRect();

        // Ïπ¥Ìä∏ ÏïÑÏù¥ÏΩò Ï§ëÏïô ÏúÑÏπò Í≥ÑÏÇ∞
        const cartCenterX = cartIconRect.left + cartIconRect.width / 2;
        const cartCenterY = cartIconRect.top + cartIconRect.height / 2;

        // Ïù¥ÎØ∏ÏßÄ Ïù¥Îèô ÏÜçÎèÑ Í≥ÑÏÇ∞
        const dx = (cartCenterX - rect.left) / 120; // x Î∞©Ìñ• Ïù¥Îèô ÏÜçÎèÑ
        const dy = (cartCenterY - rect.top) / 120; // y Î∞©Ìñ• Ïù¥Îèô ÏÜçÎèÑ

        // Ïù¥ÎØ∏ÏßÄ ÌÅ¨Í∏∞ Í∞êÏÜå ÏÜçÎèÑ Í≥ÑÏÇ∞
        const dw = (250 - 100) / 120; // Ïù¥ÎØ∏ÏßÄ ÌÅ¨Í∏∞ Í∞êÏÜå ÏÜçÎèÑ

        // Ïù¥ÎØ∏ÏßÄ Ïù¥Îèô Î∞è ÌÅ¨Í∏∞ Ï°∞Ï†à Ìï®Ïàò
        function moveImage() {
            rect = imgClone.getBoundingClientRect();
            if ((dx > 0 && rect.left < cartCenterX) || (dx < 0 && rect.left > cartCenterX) ||
                (dy > 0 && rect.top < cartCenterY) || (dy < 0 && rect.top > cartCenterY)) {
                imgClone.style.left = (rect.left + dx) + 'px';
                imgClone.style.top = (rect.top + dy) + 'px';

                // Ïù¥ÎØ∏ÏßÄ ÌÅ¨Í∏∞ Ï°∞Ï†à
                const newWidth = parseFloat(imgClone.style.width) - dw;
                imgClone.style.width = newWidth + 'px';
                imgClone.style.height = newWidth + 'px';

                requestAnimationFrame(moveImage);
            } else {
                imgClone.remove();
            }
        }

        // Ïù¥ÎØ∏ÏßÄ Ïù¥Îèô ÏãúÏûë
        moveImage();
    }
}



    document.getElementById('submitOrderBtn').addEventListener('click', function () {
        const selectedItemsArray = Object.entries(selectedItems).map(([name, item]) => {
            return {name: name, count: item.count};
        });

        const totalPrice = calculateTotalPrice(selectedItems);

        $.ajax({
            url: '/orders/submit_order/',
            cache: false,
            dataType: 'json',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({items: selectedItemsArray, total_price: totalPrice}),
            beforeSend: function (xhr) {
                xhr.setRequestHeader('X-CSRFToken', $.cookie('csrftoken'));
            },
            success: function (data) {
                console.log('Ï£ºÎ¨∏Ïù¥ ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Ï≤òÎ¶¨ÎêòÏóàÏäµÎãàÎã§.');
                window.location.href = '/orders/order_complete/' + data.order_number + '/';
            },
            error: function (error) {
                console.error('Ï£ºÎ¨∏ Ï≤òÎ¶¨ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§:', error);
            }
        });
    });

    function calculateTotalPrice(selectedItems) {
        let totalPrice = 0;
        for (const item of Object.values(selectedItems)) {
            totalPrice += item.price * item.count;
        }
        return totalPrice;
    }
</script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
</body>
</html>
