<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Silver Lining</title>
    <!-- Bootstrap CSS -->
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* 기존 스타일 */

        .menu-item,
        .selected-item {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 10px;
            margin: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            flex-direction: column;
            transition: transform 0.2s;
        }

        .menu-item img {
            width: 250px;
            height: 250px;
        }

        .menu-item:hover {
            transform: scale(1.05);
        }

        .selected-item span {
            margin: 0 5px;
        }

        .actions button {
            margin: 5px;
        }

        .card-body {
            text-align: center;
        }

        .fly-to-cart {
            position: absolute;
            z-index: 1000;
            transition: transform 1s ease-in-out;
        }

        /* 추가한 스타일 */
        #selectedItemsList {
            display: flex;
            flex-direction: column;
            gap: 10px;
            align-items: center;
        }

        .selected-item {
            display: flex;
            align-items: center;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            flex-direction: row;
            width: 600px; /* 너비를 조정합니다. */
            margin: 5px 0;
        }

        .selected-item img {
            width: 50px;
            height: 50px;
            margin-right: 10px;
        }
    </style>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.min.js"></script>
    <!-- axios 스크립트 추가 -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

</head>
<body>
<div class="container mt-5">
    <h2 class="text-center mb-4">Silver Lining</h2>
    <!-- 음성 입력 폼 추가 -->
    <h2>음성 입력하기</h2>
    <form id="speechForm"> <!-- 폼 추가 -->
        {% csrf_token %}
        <!-- 다른 폼 입력 요소들 -->
        <button type="button" id="startButton">음성 입력 시작</button> <!-- type="button" 추가 -->
    </form>
    <p id="transcription"></p>

    <div class="button d-flex flex-wrap justify-content-center">
        {% for menu in menus %}
            <div class="menu-item card"
                 onclick="addItem('{{ menu.food_name }}', {{ menu.price }}, '{{ menu.img.url }}', this)">
                <img src="{% if menu.img %}{{ menu.img.url }}{% endif %}" alt="{{ menu.food_name }}"
                     class="card-img-top">
                <div class="card-body text-center">
                    <h5 class="card-title text-primary">{{ menu.food_name }}</h5>
                    <p class="card-text text-muted">{{ menu.price }}원</p>
                </div>
            </div>
        {% endfor %}
    </div>
    <div class="selected-items mt-4">
        <h3 class="text-center">선택한 상품</h3>
        <div id="selectedItemsList"></div>
    </div>
    <div class="total-price mt-3">
        <h3 class="text-center">총 금액: <span id="totalPrice">0원</span></h3>
    </div>
    <div class="actions text-center">
        <button class="btn btn-danger" onclick="clearItems()">전체삭제</button>
        <button class="btn btn-success" id="submitOrderBtn">결제하기</button>
    </div>
</div>
<script>
    const startButton = document.getElementById('startButton');
    const transcription = document.getElementById('transcription');

    // CSRF 토큰을 가져오는 함수
    function getCsrfToken() {
        const csrfTokenElement = document.querySelector('input[name="csrfmiddlewaretoken"]');
        if (csrfTokenElement) {
            return csrfTokenElement.value;
        } else {
            console.error('CSRF 토큰을 찾을 수 없습니다.');
            return null;
        }
    }

    // 음성 합성 함수
    function speak(text) {
        const synth = window.speechSynthesis;
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = 'ko-KR';
        synth.speak(utterance);
    }

    // 음성 인식 시작 함수
    function startSpeechRecognition() {
        // 음성 인식 API를 지원하는지 확인
        if (!('webkitSpeechRecognition' in window)) {
            alert("음성 인식이 지원되지 않는 브라우저입니다.");
        } else {
            const recognition = new webkitSpeechRecognition(); // 음성 인식 객체 생성
            recognition.lang = 'ko-KR'; // 언어 설정 (한국어)

            recognition.start(); // 음성 인식 시작

            // 음성 인식 결과 이벤트 처리
            recognition.onresult = function (event) {
                const transcript = event.results[0][0].transcript;
                transcription.textContent = transcript;

                // CSRF 토큰 가져오기
                const csrfToken = getCsrfToken();

                // 서버로 음성 데이터 전송
                axios.post('{% url "orders:aibot" %}', {inputText: transcript}, {
                    headers: {
                        'X-CSRFToken': csrfToken // CSRF 토큰을 요청 헤더에 추가
                    }
                })
                    .then(function (response) {
                        const responseText = response.data.responseText;
                        console.log('서버 응답:', responseText);
                        // 서버 응답을 음성으로 출력
                        speak(responseText);
                        window.location.href = '/orders/menu/';
                    })
                    .catch(function (error) {
                        console.error('에러:', error);
                    });
            };

            // 음성 인식 종료 이벤트 처리
            recognition.onend = function () {
                startButton.textContent = '음성 입력 다시 시작';
            };
        }
    }

    // 버튼 클릭 시 음성 인식 시작
    startButton.addEventListener('click', startSpeechRecognition);
    const selectedItems = {};

    function addItem(name, price, imgUrl, element) {
        if (selectedItems[name]) {
            selectedItems[name].count++;
        } else {
            selectedItems[name] = {price: price, count: 1, imgUrl: imgUrl};
        }

        updateSelectedItemsList();

        // Delay flyToCart to ensure the element is in the DOM
        setTimeout(() => {
            const targetElement = document.getElementById(`item-${name}`);
            flyToCart(element, targetElement);
        }, 100);
    }

    function updateSelectedItemsList() {
        const selectedItemsList = document.getElementById('selectedItemsList');
        const totalPriceElement = document.getElementById('totalPrice');
        selectedItemsList.innerHTML = '';
        let totalPrice = 0;
        for (const [name, item] of Object.entries(selectedItems)) {
            const itemElement = document.createElement('div');
            itemElement.className = 'selected-item list-group-item d-flex justify-content-between align-items-center';
            itemElement.id = `item-${name}`;

            const itemImg = document.createElement('img');
            itemImg.src = item.imgUrl;
            itemImg.style.width = '50px';
            itemImg.style.height = '50px';
            itemImg.style.marginRight = '10px';

            const itemName = document.createElement('span');
            itemName.textContent = name;

            const itemCount = document.createElement('span');
            itemCount.className = 'badge badge-primary badge-pill';
            itemCount.textContent = `${item.count}개`;

            const itemPrice = document.createElement('span');
            itemPrice.textContent = `${item.price * item.count}원`;

            itemElement.appendChild(itemImg);
            itemElement.appendChild(itemName);
            itemElement.appendChild(itemCount);
            itemElement.appendChild(itemPrice);

            selectedItemsList.appendChild(itemElement);

            totalPrice += item.price * item.count;
        }
        totalPriceElement.textContent = `${totalPrice}원`;
    }

    function clearItems() {
        for (const key in selectedItems) {
            delete selectedItems[key];
        }
        updateSelectedItemsList();
    }

    function flyToCart(element, targetElement) {
        const imgToDrag = element.querySelector("img");
        if (imgToDrag) {
            const imgClone = imgToDrag.cloneNode(true);
            const rect = imgToDrag.getBoundingClientRect();
            imgClone.style.position = 'absolute';
            imgClone.style.top = rect.top + 'px';
            imgClone.style.left = rect.left + 'px';
            imgClone.style.width = '100px';
            imgClone.style.height = '100px';
            imgClone.classList.add('fly-to-cart');
            document.body.appendChild(imgClone);

            const targetRect = targetElement.getBoundingClientRect();
            setTimeout(() => {
                imgClone.style.transform = `translate(${targetRect.left - rect.left}px, ${targetRect.top - rect.top}px) scale(0.5)`;
            }, 10);

            setTimeout(() => {
                imgClone.remove();
            }, 1000);
        }
    }

    document.getElementById('submitOrderBtn').addEventListener('click', function () {
        const selectedItemsArray = Object.entries(selectedItems).map(([name, item]) => {
            return {name: name, count: item.count};
        });

        const totalPrice = calculateTotalPrice(selectedItems);

        $.ajax({
            url: '/orders/submit_order/',
            cache: false,
            dataType: 'json',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({items: selectedItemsArray, total_price: totalPrice}),
            beforeSend: function (xhr) {
                xhr.setRequestHeader('X-CSRFToken', $.cookie('csrftoken'));
            },
            success: function (data) {
                console.log('주문이 성공적으로 처리되었습니다.');
                window.location.href = '/orders/order_complete/' + data.order_number + '/';
            },
            error: function (error) {
                console.error('주문 처리 중 오류가 발생했습니다:', error);
            }
        });
    });

    function calculateTotalPrice(selectedItems) {
        let totalPrice = 0;
        for (const item of Object.values(selectedItems)) {
            totalPrice += item.price * item.count;
        }
        return totalPrice;
    }
</script>
<!-- Bootstrap JS and dependencies -->
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
</body>
</html>
