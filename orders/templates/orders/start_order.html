<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Face Recognition</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
<h1>Face Recognition</h1>
<video id="video" width="640" height="480" autoplay></video>
<button onclick="startFaceRecognition()">얼굴 인식</button>

{% csrf_token %}

<script>
    // 웹캠 스트림 가져오기
    navigator.mediaDevices.getUserMedia({video: true})
        .then(function (stream) {
            var video = document.getElementById('video');
            video.srcObject = stream;
            video.play();
        })
        .catch(function (err) {
            console.error('Error accessing webcam:', err);
        });

    // 얼굴 인식 후 이미지 데이터 전송
    function sendImageToBackend(imageData) {
        var csrfToken = $('#csrf_token').val();
        $.ajax({
            url: '/orders/face_recognition/',
            type: 'POST',
            headers: {'X-CSRFToken': csrfToken},  // CSRF 토큰을 헤더에 포함
            data: {image_data: imageData},
            success: function (response) {
                console.log('Success:', response);
                // 처리 결과에 따른 동작 수행
            },
            error: function (xhr, status, error) {
                console.error('Error:', error);
                // 에러 처리
            }
        });
    }

    // 얼굴 인식 버튼 클릭 시 호출되는 함수
    function startFaceRecognition() {
        var canvas = document.createElement('canvas');
        var context = canvas.getContext('2d');
        var video = document.getElementById('video');

        // 비디오 프레임을 캔버스에 그려서 이미지 데이터 획득
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        context.drawImage(video, 0, 0, canvas.width, canvas.height);

        var imageData = canvas.toDataURL('image/jpeg');

        // 얼굴 인식 결과를 백엔드로 전송
        sendImageToBackend(imageData);
    }
</script>
</body>
</html>
